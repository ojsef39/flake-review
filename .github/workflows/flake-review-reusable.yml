name: Flake Review (Reusable)

on:
  workflow_call:
    inputs:
      flake-review-ref:
        description: "flake-review git ref to install (tag, branch, or SHA)"
        type: string
        default: "main"
      install-from-checkout:
        description: "Install flake-review from the checked-out repo (for testing PRs to flake-review itself)"
        type: boolean
        default: false
      matrix:
        description: "JSON array of {runner, systems, name} objects"
        type: string
        default: '[{"runner":"macos-latest","systems":"aarch64-darwin,x86_64-darwin","name":"darwin"},{"runner":"ubuntu-latest","systems":"x86_64-linux","name":"linux"},{"runner":"ubuntu-24.04-arm","systems":"aarch64-linux","name":"linux-arm"}]'
      max-workers:
        description: "Max parallel build workers"
        type: number
        default: 4
      packages:
        description: "Comma-separated list of packages to review (default: all changed packages)"
        type: string
        required: false
      concurrency-group:
        description: "Concurrency group for cancelling outdated runs"
        type: string
        required: false
concurrency:
  group: ${{ inputs.concurrency-group || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: true

jobs:
  review:
    permissions:
      actions: write
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(inputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3.15.2
        with:
          extra-conf: |
            extra-experimental-features = nix-command flakes
            extra-substituters = https://cache.nixos.org https://nix-community.cachix.org
            extra-trusted-substituters = https://cache.nixos.org https://nix-community.cachix.org
            extra-trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
      - name: Restore Nix cache
        uses: nix-community/cache-nix-action/restore@v7
        id: restore
        with:
          primary-key: nix-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-${{ runner.arch }}-
          save: "false"
      - name: Install nix-diff
        run: |
          nix profile add nixpkgs#nix-diff
          echo "$HOME/.nix-profile/bin" >> "$GITHUB_PATH"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install flake-review
        run: |
          if [ "${{ inputs.install-from-checkout }}" = "true" ]; then
            pip install . --quiet
          else
            pip install "git+https://github.com/ojsef39/flake-review.git@${{ inputs.flake-review-ref }}" --quiet
          fi
      - name: Review ${{ matrix.name }} packages
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          pkg_args=()
          if [ -n "${{ inputs.packages }}" ]; then
            IFS=',' read -ra pkgs <<< "${{ inputs.packages }}"
            for p in "${pkgs[@]}"; do
              pkg_args+=(--package "$p")
            done
          fi
          flake-review pr \
            "${{ github.event.pull_request.html_url }}" \
            --systems ${{ matrix.systems }} \
            --max-workers ${{ inputs.max-workers }} \
            --output-file ${{ matrix.name }}-report.json \
            --output-format json \
            "${pkg_args[@]}"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.name }}-report
          path: ${{ matrix.name }}-report.json
      - name: Fix Nix store permissions
        if: always() && runner.os == 'Linux'
        run: sudo chmod -R a+r /nix/store
      - name: Save Nix cache
        if: always()
        uses: nix-community/cache-nix-action/save@v7
        with:
          primary-key: ${{ steps.restore.outputs.primary-key }}
          gc-max-store-size-linux: 9G
          gc-max-store-size-macos: 9G
          purge: true
          purge-prefixes: nix-${{ runner.os }}-${{ runner.arch }}-
          purge-last-accessed: P7D

  post-results:
    needs: [review]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: reports
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install flake-review
        run: |
          if [ "${{ inputs.install-from-checkout }}" = "true" ]; then
            pip install . --quiet
          else
            pip install "git+https://github.com/ojsef39/flake-review.git@${{ inputs.flake-review-ref }}" --quiet
          fi
      - name: Merge and post results
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          shopt -s nullglob
          json_files=(reports/*/*.json)
          if [ "${#json_files[@]}" -eq 0 ]; then
            echo "No report files found - no packages changed across all platforms."
            exit 0
          fi
          flake-review merge-reports \
            "${json_files[@]}" \
            --title "Flake Review Results for [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})" \
            --post-result \
            --pr-url "${{ github.event.pull_request.html_url }}"
